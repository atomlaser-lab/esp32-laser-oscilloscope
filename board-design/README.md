# Circuit and PCB for remote locking

This PCB and associated enclosure is intended to be used in conjunction with an ESP32 development board for the purposes of providing a remote interface for locking MOGLabs diode lasers.  It is intended that the MOGLabs DLC handles the locking process, and that this board and its circuitry is used for acquiring the lock.  The PCB provides a convenient way of acquiring input signals and producing appropriate output signals for the DLC.

PDFs of the circuit diagram and the PCB can be found under the plots/ directory.  Electronic design was done in KiCAD 6, and the enclosure was generated with FreeCAD 0.20.2.  Gerber files for manufacturing the PCB can be found in "generated.zip".  Digikey part numbers and quantities for 2 boards can be found under 'moglabs-remote-locking-board.txt' and 'auxliliary-parts.txt'.

## Circuit design

The idea behind this project is to use a WiFi-enabled microcontroller to measure locking signals from a diode laser, present those to a user through a web interface, accept user input to enable the lock or change the lock position, and then to produce output signals to act on user input.  The core of the board is an ESP32-DevKitC-v4 board, which can use a number of different microcontrollers but with the same board pinout and form factor.  The part chosen for this project is the ESP32-DEVKITC-VE with an ESP32-WROVER-E microcontroller.  Other chips with the same pinout and form factor can also be used.

Two analog signals are recorded by the microcontroller unit (MCU): the error or locking signal, denoted as "Lock", and the raw photodiode signal, denote as "PD".  The MCU's ADCs can only record positive voltages, and the error signal by definition must be bipolar, so an op-amp and associated components is used to add a 1.5 V offset to the signal while also inverting it (the inversion is simply a side-effect).  This should put the error signal at the midpoint of the ADC's voltage range.  A pair of Schottky diodes is used to clip the voltage to the 0 V and 3.3 V rails.  The PD signal should always be positive, and it is similarly clipped to the 0 V and 3.3 V rails.  The Lock signal is recorded using ADC1_CH0 or GPIO36, and the PD signal is recorded using ADC1_CH3 or GPIO39.  Finally, the trigger generated by the MOGLabs DLC is recorded using the digital input channel GPIO34 after passing through a voltage divider to bring the 5 V level to 3.3 V.  As the actual lock is handled by the DLC the quality of the recorded input signals is not particularly important, and we have thus used the MCU's internal ADCs.

The output signals are more important, and the on-board DACs don't work well when the WiFi is also running.  Therefore, we use a dual-channel DAC (MCP4822) which interfaces with the MCU via SPI to produce output signals for both the piezo control (PZT) and the diode current (Current).  The DAC produces a unipolar output, so a dual-channel op-amp is used to offset the voltage and generate a bipolar output.  The DAC in this case has a selectable voltage reference, and here we have assumed that it is set such that the reference voltage is 4.096 V which is also the default on power-on.  Resistors R5-R8 and R10-R13 are chosen to produce voltage outputs as close as possible to a bipolar output.  The resistors are chosen to give an approximate +/-0.2 V output on the output for each channel

It is expected that power will typically be supplied via the development board's USB connector, which is nominally +5 V.  However, users can instead supply +5 V to the J1 pin header, which will power both the development board and the rest of the circuitry.  Bipolar +/-5 V is generated by the switched-mode power supply PS1, and the VDD and VSS pins on the op-amps are connected to the appropriate pins on the power supply.  This power supply can supply up to 100 mA, and it technically has a minimum load of 10 mA, but the datasheet states that no damage will occur if operated with loads below 10 mA.  It is expected that output ripple will probably be worse than specified if the current draw is less than 10 mA.  If a bipolar supply is present, one could not populate PS1 and instead connect the bipolar +/-5 V rails to the appropriately labelled connections on the board, possible through the use of a standard 2.54 mm pitch pin header.  Users would then need to connect the +5 V rail to the development board.

The development board can be connected to the PCB in one of two ways.  The first is to solder male pin headers to the PCB and then solder the development board to the male pin header: this will provide the smallest possible footprint.  The second way is to solder female pin sockets to the PCB and then solder male pin headers to the development board and attach it to the PCB in a solder-less connection.  This is probably the better option, even though it involves more soldering, because if the development board needs to be removed it is a hassle to de-solder 38 separate pins.

Finally, most of the GPIO pins on the development board are broken out on the female pin sockets J5 and J9.  Of primary importance are GPIOs 16, 4, 0, and 2 which control the MOGLabs DLC, and these are the digital laser control signals and will need to be connected to the DLC through separate cables.  It is recommended that wires connected to a male pin header are used for the connection.

The PCB has four M3 mounting holes in the corner of the board.  These can be safely used with standard metal bolts as they are not connected to any of the electrical signals.

## Enclosure

The enclosure is designed with the expectation that it will be 3D printed.  The interior of the box has four posts intended for attaching the PCB via the M3 mounting holes.





